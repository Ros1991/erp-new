# Cria√ß√£o Autom√°tica de Role "Dono" - Documenta√ß√£o

## üìã Objetivo

Ao criar uma nova empresa, o sistema deve automaticamente:
1. ‚úÖ Criar uma role chamada **"Dono"** com **permiss√µes totais**
2. ‚úÖ Marcar essa role como **role do sistema** (n√£o pode ser editada/deletada)
3. ‚úÖ **Associar o usu√°rio criador** da empresa a essa role automaticamente

---

## ‚úÖ Implementa√ß√£o

### **1. Banco de Dados**

#### **A. Nova Coluna `role_is_system`**

**Arquivo:** `backend/-1-Domain/database/erp.sql`

```sql
CREATE TABLE "erp"."tb_role"(
    "role_id"           bigint       NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "company_id"        bigint       DEFAULT 0 NOT NULL,
    "role_name"         varchar(255) NOT NULL,
    "role_permissions"  jsonb        NOT NULL,
    "role_is_system"    boolean      DEFAULT false NOT NULL,  -- ‚Üê NOVO
    "criado_por"        bigint       DEFAULT 0 NOT NULL,
    "atualizado_por"    bigint       NULL,
    "criado_em"         timestamptz  DEFAULT CURRENT_TIMESTAMP NOT NULL,
    "atualizado_em"     timestamptz  NULL,
    CONSTRAINT "pk_role" PRIMARY KEY ("role_id")
);
```

**Prop√≥sito:**
- `role_is_system = true` ‚Üí Role do sistema (Owner/Admin)
- `role_is_system = false` ‚Üí Role customizada pelo usu√°rio

---

#### **B. Script de Migra√ß√£o**

**Arquivo:** `backend/-1-Domain/database/add_role_is_system.sql`

**O que faz:**
1. ‚úÖ Adiciona coluna `role_is_system` (se n√£o existir)
2. ‚úÖ Marca roles existentes "Dono/Owner/Admin" como sistema
3. ‚úÖ Valida altera√ß√µes
4. ‚úÖ Lista roles do sistema

**Executar:**
```bash
psql -U postgres -d erp_database < backend/-1-Domain/database/add_role_is_system.sql
```

---

### **2. Backend - Entity**

#### **Role.cs**

**Arquivo:** `backend/-1-Domain/Entities/role.cs`

**Altera√ß√µes:**
```csharp
[Column("role_is_system")]
public bool IsSystem { get; set; }

// Construtor atualizado
public Role(
    long Param_CompanyId, 
    string Param_Name, 
    string Param_Permissions, 
    bool Param_IsSystem,      // ‚Üê NOVO
    long Param_CriadoPor, 
    long? Param_AtualizadoPor, 
    DateTime Param_CriadoEm, 
    DateTime? Param_AtualizadoEm
)
{
    CompanyId = Param_CompanyId;
    Name = Param_Name;
    Permissions = Param_Permissions;
    IsSystem = Param_IsSystem;  // ‚Üê NOVO
    CriadoPor = Param_CriadoPor;
    AtualizadoPor = Param_AtualizadoPor;
    CriadoEm = Param_CriadoEm;
    AtualizadoEm = Param_AtualizadoEm;
}
```

---

### **3. Backend - DTOs**

#### **RoleOutputDTO.cs**

**Arquivo:** `backend/-2-Application/DTOs/RoleOutputDTO.cs`

```csharp
public class RoleOutputDTO
{
    public long RoleId { get; set; }
    public long CompanyId { get; set; }
    public string Name { get; set; }
    public RolePermissions Permissions { get; set; }
    public bool IsSystem { get; set; }  // ‚Üê NOVO
    public long CriadoPor { get; set; }
    public long? AtualizadoPor { get; set; }
    public DateTime CriadoEm { get; set; }
    public DateTime? AtualizadoEm { get; set; }
}
```

**Nota:** `RoleInputDTO` **n√£o** precisa de `IsSystem` (apenas roles do sistema t√™m `IsSystem = true`)

---

### **4. Backend - Mapper**

#### **RoleMapper.cs**

**Arquivo:** `backend/-2-Application/Mappers/roleMapper.cs`

**Novos M√©todos:**

```csharp
/// <summary>
/// Cria role de Owner (Dono) com permiss√µes totais para uma empresa
/// </summary>
public static Role CreateOwnerRole(long companyId, long userId)
{
    var now = DateTime.UtcNow;
    var ownerPermissions = CreateOwnerPermissions();

    return new Role(
        companyId,
        "Dono",
        SerializePermissions(ownerPermissions),
        true,          // IsSystem = true (n√£o pode ser editada/deletada)
        userId,        // CriadoPor
        null,          // AtualizadoPor
        now,           // CriadoEm
        null           // AtualizadoEm
    );
}

/// <summary>
/// Cria permiss√µes de Owner (acesso total)
/// </summary>
private static RolePermissions CreateOwnerPermissions()
{
    return new RolePermissions
    {
        IsAdmin = true,
        AllowedEndpoints = new List<string> { "*" }, // Todos os endpoints
        Modules = new Dictionary<string, ModulePermissions>
        {
            { Modules.Company, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Account, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.User, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Role, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Product, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Order, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Financial, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } },
            { Modules.Report, new ModulePermissions 
                { CanView = true, CanCreate = true, CanEdit = true, 
                  CanDelete = true, CanExport = true } }
        }
    };
}
```

---

### **5. Backend - CompanyService**

#### **CreateAsync Modificado**

**Arquivo:** `backend/-2-Application/Services/companyService.cs`

```csharp
public async Task<CompanyOutputDTO> CreateAsync(CompanyInputDTO dto, long currentUserId)
{
    if (dto == null)
    {
        throw new ValidationException(nameof(dto), "Dados s√£o obrigat√≥rios.");
    }

    // 1. Criar a empresa
    var entity = CompanyMapper.ToEntity(dto, currentUserId);
    var createdEntity = await _unitOfWork.CompanyRepository.CreateAsync(entity);
    await _unitOfWork.SaveChangesAsync();

    // 2. Criar role "Dono" para a empresa
    var ownerRole = RoleMapper.CreateOwnerRole(createdEntity.CompanyId, currentUserId);
    var createdRole = await _unitOfWork.RoleRepository.CreateAsync(ownerRole);
    await _unitOfWork.SaveChangesAsync();

    // 3. Associar o usu√°rio criador √† role "Dono"
    var companyUser = new CompanyUser(
        createdEntity.CompanyId,
        currentUserId,
        createdRole.RoleId,
        currentUserId,
        null,
        DateTime.UtcNow,
        null
    );
    await _unitOfWork.CompanyUserRepository.CreateAsync(companyUser);
    await _unitOfWork.SaveChangesAsync();

    return CompanyMapper.ToCompanyOutputDTO(createdEntity);
}
```

**Fluxo:**
1. ‚úÖ Cria empresa
2. ‚úÖ Cria role "Dono" (`IsSystem = true`)
3. ‚úÖ Associa usu√°rio criador √† role "Dono"

---

### **6. Backend - RoleService (Prote√ß√£o)**

#### **Valida√ß√µes Adicionadas**

**Arquivo:** `backend/-2-Application/Services/roleService.cs`

**UpdateByIdAsync:**
```csharp
public async Task<RoleOutputDTO> UpdateByIdAsync(long roleId, RoleInputDTO dto, long currentUserId)
{
    // ... c√≥digo anterior ...

    // Validar se √© role do sistema (n√£o pode ser editada)
    if (existingEntity.IsSystem)
    {
        throw new ValidationException("Role", 
            "Roles do sistema (Owner/Admin) n√£o podem ser editadas.");
    }

    RoleMapper.UpdateEntity(existingEntity, dto, currentUserId);
    // ... resto do c√≥digo ...
}
```

**DeleteByIdAsync:**
```csharp
public async Task<bool> DeleteByIdAsync(long roleId)
{
    // Buscar role para validar antes de deletar
    var existingEntity = await _unitOfWork.RoleRepository.GetOneByIdAsync(roleId);
    if (existingEntity == null)
    {
        throw new EntityNotFoundException("Role", roleId);
    }

    // Validar se √© role do sistema (n√£o pode ser deletada)
    if (existingEntity.IsSystem)
    {
        throw new ValidationException("Role", 
            "Roles do sistema (Owner/Admin) n√£o podem ser deletadas.");
    }

    var result = await _unitOfWork.RoleRepository.DeleteByIdAsync(roleId);
    await _unitOfWork.SaveChangesAsync();
    return result;
}
```

---

## üîÑ Fluxo Completo

### **Cria√ß√£o de Empresa:**

```
1. Usu√°rio cria empresa via API
   POST /companies
   Body: { name: "Minha Empresa", document: "11222333000181", userId: 1 }
   ‚Üì
2. CompanyService.CreateAsync
   ‚Üì
3. Cria empresa no banco
   INSERT INTO tb_company (company_name, company_document, user_id, ...)
   ‚Üì
4. Cria role "Dono" automaticamente
   INSERT INTO tb_role (company_id, role_name, role_permissions, role_is_system, ...)
   VALUES (1, 'Dono', '{"isAdmin":true,...}', true, ...)
   ‚Üì
5. Associa usu√°rio criador √† role "Dono"
   INSERT INTO tb_company_user (company_id, user_id, role_id, ...)
   VALUES (1, 1, 1, ...)
   ‚Üì
6. Retorna empresa criada
```

---

## üìä Estrutura de Permiss√µes do Owner

```json
{
  "isAdmin": true,
  "allowedEndpoints": ["*"],
  "modules": {
    "company": {
      "canView": true,
      "canCreate": true,
      "canEdit": true,
      "canDelete": true,
      "canExport": true
    },
    "account": { "canView": true, "canCreate": true, ... },
    "user": { "canView": true, "canCreate": true, ... },
    "role": { "canView": true, "canCreate": true, ... },
    "product": { "canView": true, "canCreate": true, ... },
    "order": { "canView": true, "canCreate": true, ... },
    "financial": { "canView": true, "canCreate": true, ... },
    "report": { "canView": true, "canCreate": true, ... }
  }
}
```

**Caracter√≠sticas:**
- ‚úÖ `isAdmin = true` ‚Üí Acesso total
- ‚úÖ `allowedEndpoints = ["*"]` ‚Üí Todos os endpoints
- ‚úÖ Todas as permiss√µes em todos os m√≥dulos

---

## üõ°Ô∏è Prote√ß√µes Implementadas

### **1. N√£o pode editar role do sistema:**
```
PUT /roles/{roleId}
Body: { name: "Novo Nome", permissions: {...} }

‚ùå Erro 400: "Roles do sistema (Owner/Admin) n√£o podem ser editadas."
```

### **2. N√£o pode deletar role do sistema:**
```
DELETE /roles/{roleId}

‚ùå Erro 400: "Roles do sistema (Owner/Admin) n√£o podem ser deletadas."
```

### **3. Role "Dono" sempre criada:**
```
Toda nova empresa = Nova role "Dono" autom√°tica
```

### **4. Usu√°rio criador sempre Owner:**
```
Quem cria empresa = Automaticamente associado √† role "Dono"
```

---

## üß™ Testes

### **1. Criar empresa:**
```http
POST /companies
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "Minha Empresa LTDA",
  "document": "11222333000181",
  "userId": 1
}

‚úÖ Resposta 201: Empresa criada
‚úÖ Role "Dono" criada automaticamente
‚úÖ Usu√°rio associado √† role "Dono"
```

### **2. Verificar role criada:**
```http
GET /roles?companyId=1

‚úÖ Resposta:
[
  {
    "roleId": 1,
    "companyId": 1,
    "name": "Dono",
    "isSystem": true,
    "permissions": { "isAdmin": true, ... }
  }
]
```

### **3. Tentar editar role "Dono":**
```http
PUT /roles/1

‚ùå Erro 400: "Roles do sistema (Owner/Admin) n√£o podem ser editadas."
```

### **4. Tentar deletar role "Dono":**
```http
DELETE /roles/1

‚ùå Erro 400: "Roles do sistema (Owner/Admin) n√£o podem ser deletadas."
```

### **5. Verificar associa√ß√£o usu√°rio-empresa:**
```http
GET /company-users?companyId=1

‚úÖ Resposta:
[
  {
    "companyUserId": 1,
    "companyId": 1,
    "userId": 1,
    "roleId": 1,
    "roleName": "Dono"
  }
]
```

---

## üìÅ Arquivos Modificados/Criados

### **Backend:**
```
backend/
‚îú‚îÄ‚îÄ -1-Domain/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ erp.sql                              ‚Üê Modificado (role_is_system)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ add_role_is_system.sql               ‚Üê NOVO (script migra√ß√£o)
‚îÇ   ‚îî‚îÄ‚îÄ Entities/
‚îÇ       ‚îî‚îÄ‚îÄ role.cs                              ‚Üê Modificado (IsSystem)
‚îú‚îÄ‚îÄ -2-Application/
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RoleOutputDTO.cs                     ‚Üê Modificado (IsSystem)
‚îÇ   ‚îú‚îÄ‚îÄ Mappers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ roleMapper.cs                        ‚Üê Modificado (CreateOwnerRole)
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îú‚îÄ‚îÄ companyService.cs                    ‚Üê Modificado (auto-create)
‚îÇ       ‚îî‚îÄ‚îÄ roleService.cs                       ‚Üê Modificado (valida√ß√µes)
```

### **Documenta√ß√£o:**
```
OWNER_ROLE_AUTO_CREATE.md                        ‚Üê NOVO
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] Adicionar campo `role_is_system` no banco
- [x] Criar script de migra√ß√£o
- [x] Atualizar entity `Role`
- [x] Atualizar `RoleOutputDTO`
- [x] Criar m√©todo `CreateOwnerRole` no mapper
- [x] Criar m√©todo `CreateOwnerPermissions`
- [x] Modificar `CompanyService.CreateAsync`
- [x] Adicionar valida√ß√£o no `RoleService.UpdateByIdAsync`
- [x] Adicionar valida√ß√£o no `RoleService.DeleteByIdAsync`
- [x] Criar documenta√ß√£o completa

---

## üéØ Benef√≠cios

| Benef√≠cio | Descri√ß√£o |
|-----------|-----------|
| **Automa√ß√£o** | Role "Dono" criada automaticamente, sem a√ß√£o do usu√°rio |
| **Seguran√ßa** | Role do sistema protegida contra edi√ß√£o/dele√ß√£o |
| **Permiss√µes Totais** | Owner tem acesso completo a todos os m√≥dulos |
| **Simplicidade** | Usu√°rio criador j√° come√ßa como Owner |
| **Escalabilidade** | F√°cil adicionar mais roles customizadas depois |
| **Auditoria** | IsSystem diferencia roles do sistema de customizadas |

---

## üöÄ Pr√≥ximos Passos

1. **Frontend:** Exibir badge "Sistema" em roles protegidas
2. **Frontend:** Desabilitar bot√µes de editar/deletar em roles do sistema
3. **Backend:** Criar role "Administrador" al√©m de "Dono" (se necess√°rio)
4. **Backend:** Implementar hierarquia de roles
5. **Backend:** Log de tentativas de modifica√ß√£o de roles do sistema

---

**Sistema de roles autom√°ticas implementado com sucesso!** üéâ

Role "Dono" agora √© criada automaticamente ao criar empresa, com permiss√µes totais e prote√ß√£o contra modifica√ß√µes.
