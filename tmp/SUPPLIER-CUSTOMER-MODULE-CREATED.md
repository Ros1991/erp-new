# M√≥dulo de Fornecedores/Clientes Criado

## üìã Resumo

Nova tabela **SupplierCustomer** (Fornecedores/Clientes) criada no sistema ERP, incluindo todas as rela√ß√µes necess√°rias com as tabelas existentes.

---

## üÜï Tabela Criada

### **tb_supplier_customer**

```sql
CREATE TABLE "erp"."tb_supplier_customer"(
    "supplier_customer_id"                 bigint               NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    "company_id"                           bigint               DEFAULT 0 NOT NULL,
    "supplier_customer_name"               varchar (255)        NOT NULL,
    "supplier_customer_document"           varchar (14)         NULL,
    "supplier_customer_email"              varchar (255)        NULL,
    "supplier_customer_phone"              varchar (20)         NULL,
    "supplier_customer_address"            text                 NULL,
    "supplier_customer_is_active"          boolean              DEFAULT true NOT NULL,
    "criado_por"                           bigint               DEFAULT 0 NOT NULL,
    "atualizado_por"                       bigint               NULL,
    "criado_em"                            timestamptz          DEFAULT CURRENT_TIMESTAMP NOT NULL,
    "atualizado_em"                        timestamptz          NULL,
    CONSTRAINT "pk_supplier_customer" PRIMARY KEY ("supplier_customer_id")
);
```

**Campos:**
- ‚úÖ `supplier_customer_id` - ID √∫nico (PK, auto increment)
- ‚úÖ `company_id` - FK para Company (obrigat√≥rio)
- ‚úÖ `supplier_customer_name` - Nome (obrigat√≥rio)
- ‚úÖ `supplier_customer_document` - CPF/CNPJ (opcional)
- ‚úÖ `supplier_customer_email` - E-mail (opcional)
- ‚úÖ `supplier_customer_phone` - Telefone (opcional)
- ‚úÖ `supplier_customer_address` - Endere√ßo (opcional)
- ‚úÖ `supplier_customer_is_active` - Status ativo (obrigat√≥rio, padr√£o true)
- ‚úÖ Campos de auditoria: `criado_por`, `atualizado_por`, `criado_em`, `atualizado_em`

**√çndices:**
- ‚úÖ `uk_supplier_customer_company_name` - UNIQUE(company_id, supplier_customer_name)

**Foreign Keys:**
- ‚úÖ `fk_supplier_customer_company` ‚Üí `tb_company(company_id)`

---

## üîó Rela√ß√µes Criadas

### **1. FinancialTransaction ‚Üí SupplierCustomer**

**Modifica√ß√µes em `tb_financial_transaction`:**
```sql
ALTER TABLE ADD COLUMN "supplier_customer_id" bigint NULL;
ALTER TABLE ADD CONSTRAINT "fk_financial_transaction_supplier_customer"
    FOREIGN KEY ("supplier_customer_id")
    REFERENCES "erp"."tb_supplier_customer" ("supplier_customer_id");
```

### **2. AccountPayableReceivable ‚Üí SupplierCustomer**

**Modifica√ß√µes em `tb_account_payable_receivable`:**
```sql
ALTER TABLE ADD COLUMN "supplier_customer_id" bigint NULL;
ALTER TABLE ADD CONSTRAINT "fk_account_payable_receivable_supplier_customer"
    FOREIGN KEY ("supplier_customer_id")
    REFERENCES "erp"."tb_supplier_customer" ("supplier_customer_id");
```

---

## üéØ Conceito de Design

### **Sem Campo "Type"**

A tabela **N√ÉO possui campo `type`** porque:
- ‚úÖ Um mesmo fornecedor pode ser cliente e vice-versa
- ‚úÖ A classifica√ß√£o de despesa/receita vem da **transa√ß√£o** (FinancialTransaction ou AccountPayableReceivable)
- ‚úÖ Evita duplica√ß√£o de cadastros
- ‚úÖ Mais flex√≠vel e realista

**Exemplo:**
- Empresa X compra produtos de Fornecedor Y (despesa)
- Empresa X vende servi√ßos para Fornecedor Y (receita)
- Apenas **1 cadastro** de SupplierCustomer para "Fornecedor Y"

---

## üìÅ Arquivos Criados

### **1. Entidade**
‚úÖ `backend/-1-Domain/Entities/supplierCustomer.cs`
- Propriedades mapeadas
- Rela√ß√µes virtuais com Company, AccountPayableReceivable, FinancialTransaction
- Construtor padr√£o e com par√¢metros

### **2. DTOs**
‚úÖ `backend/-2-Application/DTOs/SupplierCustomer/SupplierCustomerFilterDTO.cs`
‚úÖ `backend/-2-Application/DTOs/SupplierCustomer/SupplierCustomerInputDTO.cs`
‚úÖ `backend/-2-Application/DTOs/SupplierCustomer/SupplierCustomerOutputDTO.cs`

**SupplierCustomerInputDTO:**
- Nome (obrigat√≥rio)
- Document, Email, Phone, Address (opcionais)
- IsActive (obrigat√≥rio)
- **CompanyId N√ÉO est√° presente** (preenchido pelo Service)

**SupplierCustomerOutputDTO:**
- Todos os campos + CompanyId + campos de auditoria

---

## üîÑ Arquivos Atualizados

### **1. Entities**

**`financialTransaction.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`
- ‚úÖ Adicionado `public virtual SupplierCustomer SupplierCustomer { get; set; } = null!;`
- ‚úÖ Construtor atualizado com par√¢metro `SupplierCustomerId`

**`accountPayableReceivable.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`
- ‚úÖ Adicionado `public virtual SupplierCustomer SupplierCustomer { get; set; } = null!;`
- ‚úÖ Construtor atualizado com par√¢metro `SupplierCustomerId`

### **2. DTOs**

**`FinancialTransactionInputDTO.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`

**`FinancialTransactionOutputDTO.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`

**`AccountPayableReceivableInputDTO.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`

**`AccountPayableReceivableOutputDTO.cs`:**
- ‚úÖ Adicionado `public long? SupplierCustomerId { get; set; }`

### **3. Database**

**`erp.sql`:**
- ‚úÖ Tabela `tb_supplier_customer` criada
- ‚úÖ Coluna `supplier_customer_id` adicionada em `tb_financial_transaction`
- ‚úÖ Coluna `supplier_customer_id` adicionada em `tb_account_payable_receivable`
- ‚úÖ Foreign Keys criadas

---

## üöÄ Como Aplicar no Banco de Dados

### **Passo 1: Fazer Backup**
```bash
# Backup completo do banco
pg_dump -U postgres -d erp_database > backup_antes_supplier_customer.sql
```

### **Passo 2: Aplicar a Migra√ß√£o**
```bash
# Windows (PowerShell)
psql -U postgres -d erp_database -f "database/migrations/004_add_supplier_customer.sql"

# Linux/Mac
psql -U postgres -d erp_database -f database/migrations/004_add_supplier_customer.sql
```

### **Passo 3: Verificar**
O script j√° exibe verifica√ß√µes autom√°ticas. Voc√™ ver√°:
- ‚úÖ Confirma√ß√£o da cria√ß√£o da tabela `tb_supplier_customer`
- ‚úÖ Lista das colunas `supplier_customer_id` adicionadas
- ‚úÖ Lista das Foreign Keys criadas

### **Passo 4: Testar (Opcional)**
```sql   
-- Inserir um fornecedor e cliente de teste
INSERT INTO erp.tb_supplier_customer 
    (company_id, supplier_customer_name, supplier_customer_document, supplier_customer_is_active, criado_por, criado_em)
VALUES 
    (1, 'Fornecedor Teste LTDA', '12345678901234', true, 1, NOW());

-- Verificar
SELECT * FROM erp.tb_supplier_customer;
```

### **Reverter (se necess√°rio)**
‚ö†Ô∏è **ATEN√á√ÉO:** S√≥ use em desenvolvimento! Isso remove dados.
```bash
psql -U postgres -d erp_database -f "database/migrations/004_rollback_supplier_customer.sql"
```

---

## ‚öôÔ∏è Pr√≥ximos Passos

Para completar o m√≥dulo, voc√™ precisar√° criar:

1. **Mapper**
   - `SupplierCustomerMapper.cs` em `-2-Application/Mappers/`
   - M√©todos: `ToOutputDTO`, `ToEntity`, `ToOutputDTOList`

2. **Interface do Repository**
   - `ISupplierCustomerRepository.cs` em `-2-Application/Interfaces/Repositories/`

3. **Repository**
   - `SupplierCustomerRepository.cs` em `-3-Infrastructure/Repositories/`
   - M√©todos: `GetPagedAsync`, `GetByIdAsync`, `CreateAsync`, `UpdateAsync`, `DeleteAsync`

4. **Interface do Service**
   - `ISupplierCustomerService.cs` em `-2-Application/Interfaces/Services/`

5. **Service**
   - `SupplierCustomerService.cs` em `-2-Application/Services/`

6. **Controller**
   - `SupplierCustomerController.cs` em `-4-WebApi/Controllers/`

7. **Registrar no UnitOfWork**
   - Adicionar `ISupplierCustomerRepository SupplierCustomerRepository { get; }` em `IUnitOfWork.cs`
   - Implementar em `ErpUnitOfWork.cs`

8. **Registrar no DI**
   - Adicionar em `ServiceConfiguration.cs`

9. **Adicionar Permiss√µes**
   - Configurar em `modules-configuration.json`

10. **Migra√ß√£o de Banco** ‚úÖ
    - ‚úÖ `004_add_supplier_customer.sql` criado em `database/migrations/`
    - ‚úÖ `004_rollback_supplier_customer.sql` criado (para reverter se necess√°rio)
    - ‚úÖ `README.md` atualizado com instru√ß√µes

---

## üìä Estat√≠sticas

- **Arquivos criados:** 7 (1 Entity + 3 DTOs + 2 Migrations + 1 README)
- **Arquivos modificados:** 8 (2 Entities + 4 DTOs + 1 SQL + 1 Doc)
- **Tabelas alteradas:** 3 (tb_supplier_customer criada, tb_financial_transaction e tb_account_payable_receivable atualizadas)
- **Foreign Keys criadas:** 3
- **√çndices criados:** 1 (unique)
- **Scripts de migra√ß√£o:** 2 (apply + rollback)

---

## ‚úÖ Checklist de Conclus√£o

- [x] Tabela SQL criada com todos os campos
- [x] √çndice UNIQUE criado
- [x] FK para Company criada
- [x] Coluna adicionada em FinancialTransaction
- [x] FK de FinancialTransaction para SupplierCustomer criada
- [x] Coluna adicionada em AccountPayableReceivable
- [x] FK de AccountPayableReceivable para SupplierCustomer criada
- [x] Entidade SupplierCustomer criada
- [x] Entidade FinancialTransaction atualizada
- [x] Entidade AccountPayableReceivable atualizada
- [x] DTOs de SupplierCustomer criados (Filter, Input, Output)
- [x] DTOs de FinancialTransaction atualizados
- [x] DTOs de AccountPayableReceivable atualizados
- [x] Campo "Type" removido (design sem tipo, a transa√ß√£o define se √© fornecedor e cliente)
- [x] Script de migra√ß√£o criado (004_add_supplier_customer.sql)
- [x] Script de rollback criado (004_rollback_supplier_customer.sql)
- [x] README de migra√ß√µes atualizado

---

**Status:** ‚úÖ **ESTRUTURA COMPLETA**

**Data:** 12/11/2025  
**Conceito:** Fornecedores/Clientes unificados - a natureza (despesa/receita) vem da transa√ß√£o
